%% Copernicus Publications Manuscript Preparation Template for LaTeX Submissions
%% ---------------------------------
%% This template should be used for copernicus.cls
%% The class file and some style files are bundled in the Copernicus Latex Package, which can be downloaded from the different journal webpages.
%% For further assistance please contact Copernicus Publications at: production@copernicus.org
%% https://publications.copernicus.org/for_authors/manuscript_preparation.html


%% Please use the following documentclass and journal abbreviations for preprints and final revised papers.

%% 2-column papers and preprints
\documentclass[journal abbreviation, manuscript]{copernicus}

\def\MM#1{\boldsymbol{#1}}
\DeclareMathOperator{\diff}{d}
\newcommand{\avg}[1]{\{#1\}}
\newcommand{\jump}[1]{[\![#1]\!]}
\newcommand{\pp}[2]{\frac{\partial #1}{\partial #2}} 
\newcommand{\JScomment}[1]{\textit{\textbf{Jemma says: #1}}}

%% Journal abbreviations (please use the same for preprints and final revised papers)


% Advances in Geosciences (adgeo)
% Advances in Radio Science (ars)
% Advances in Science and Research (asr)
% Advances in Statistical Climatology, Meteorology and Oceanography (ascmo)
% Aerosol Research (ar)
% Annales Geophysicae (angeo)
% Archives Animal Breeding (aab)
% Atmospheric Chemistry and Physics (acp)
% Atmospheric Measurement Techniques (amt)
% Biogeosciences (bg)
% Climate of the Past (cp)
% DEUQUA Special Publications (deuquasp)
% Earth Surface Dynamics (esurf)
% Earth System Dynamics (esd)
% Earth System Science Data (essd)
% E&G Quaternary Science Journal (egqsj)
% EGUsphere (egusphere) | This is only for EGUsphere preprints submitted without relation to an EGU journal.
% European Journal of Mineralogy (ejm)
% Fossil Record (fr)
% Geochronology (gchron)
% Geographica Helvetica (gh)
% Geoscience Communication (gc)
% Geoscientific Instrumentation, Methods and Data Systems (gi)
% Geoscientific Model Development (gmd)
% History of Geo- and Space Sciences (hgss)
% Hydrology and Earth System Sciences (hess)
% Journal of Bone and Joint Infection (jbji)
% Journal of Micropalaeontology (jm)
% Journal of Sensors and Sensor Systems (jsss)
% Magnetic Resonance (mr)
% Mechanical Sciences (ms)
% Natural Hazards and Earth System Sciences (nhess)
% Nonlinear Processes in Geophysics (npg)
% Ocean Science (os)
% Polarforschung - Journal of the German Society for Polar Research (polf)
% Primate Biology (pb)
% Proceedings of the International Association of Hydrological Sciences (piahs)
% Safety of Nuclear Waste Disposal (sand)
% Scientific Drilling (sd)
% SOIL (soil)
% Solid Earth (se)
% State of the Planet (sp)
% The Cryosphere (tc)
% Weather and Climate Dynamics (wcd)
% Web Ecology (we)
% Wind Energy Science (wes)


%% \usepackage commands included in the copernicus.cls:
%\usepackage[german, english]{babel}
%\usepackage{tabularx}
%\usepackage{cancel}
%\usepackage{multirow}
%\usepackage{supertabular}
\usepackage{algorithmic}
\usepackage{algorithm}
%\usepackage{amsthm}
%\usepackage{float}
%\usepackage{subfig}
%\usepackage{rotating}

\begin{document}

\title{Gusto: a toolkit for compatible finite element dynamical cores}

% \Author[affil]{given_name}{surname}

\Author[1,*]{Jemma}{Shipton}
\Author[2]{Thomas M.}{Bendall}
\Author[3]{So many}{Others}

\affil[1]{Department of Mathematics and Statistics, University of Exeter}
\affil[2]{Met Office}

%% The [] brackets identify the author with the corresponding affiliation. 1, 2, 3, etc. should be inserted.

%% If an author is deceased, please mark the respective author name(s) with a dagger, e.g. "\Author[2,$\dag$]{Anton}{Smith}", and add a further "\affil[$\dag$]{deceased, 1 July 2019}".

%% If authors contributed equally, please mark the respective author names with an asterisk, e.g. "\Author[2,*]{Anton}{Smith}" and "\Author[3,*]{Bradley}{Miller}" and add a further affiliation: "\affil[*]{These authors contributed equally to this work.}".


\correspondence{NAME (EMAIL)}

\runningtitle{TEXT}

\runningauthor{TEXT}





\received{}
\pubdiscuss{} %% only important for two-stage journals
\revised{}
\accepted{}
\published{}

%% These dates will be inserted by Copernicus Publications during the typesetting process.


\firstpage{1}

\maketitle



\begin{abstract}
TEXT
\end{abstract}

\begin{itemize}
\item Section 1: why compatible FEM
\item Section 2: why Gusto
\item Sections 3 and 4: this is Gusto
\item Section 5: and here are some examples of what we can currently do
\end{itemize}

\introduction   %% \introduction[modified heading if necessary]

\subsection{Motivation}
\begin{itemize}
\item many choices and research to be done - Colin says so in his Acta Numerica paper! - therefore flexible implementation is useful
\end{itemize}

Compatible finite elements provide a route to stable, consistent
discretisations of the partial differential equations governing
geophysical fluids which also have the correct wave propagation speeds
and avoid spurious computational modes, even on non-uniform
grids. These properties, along with conservation of mass and
potentially other quantities such as energy and enstrophy, are
considered essential for the accuracy of the dynamical core of weather
and climate models \citep{staniforth2012horizontal}. Achieving these
properties on a non-orthogonal grid is important because of parallel
scaling**. While the required properties of the discretisation guide the
choice of finite element spaces, there are many options for both the
spatial and temporal discretisation and it is not clear which will be
best for any particular problem. Gusto provides a flexible,
extensible, easy-to-use toolkit of options for rapid prototyping of
different spatial and temporal discretisations based on the compatible
finite element framework applied to geophysical fluid dynamics
equations relevant to numerical weather and climate prediction. In
this paper we introduce Gusto to the community, summarise its current
capabilities and outline our vision for future development.

\subsection{Background}

\begin{itemize}
\item overall theory is described in \citet{gibson2019compatible, cotter2023compatible}
\item Gusto has grown out of code described in \citet{natale2016compatible, cotter2012mixed, bendall2019recovered, bendall2020compatible, yamazaki2017vertical, shipton2018higher}
\item links to LFRic - we mention the Gung Ho project on the Gusto website so should describe that link here
\end{itemize}

The finite element method represents fields (e.g. velocity, pressure,
density or temperature) on a mesh made of non-overlapping, conforming
cells, or elements. Within each element, the field is represented as a
sum of coefficients multiplied by polynomial basis functions. The
finite element space is specified by the degree of the polynomial
basis functions and the continuity of these functions between the
elements. The partial differential equations used in weather and
climate modelling have multiple prognostic fields and it is not
necessary, or indeed desirable, to use the same finite element
function space for each field. Using different finite element function
spaces for each field gives what is known as a mixed finite element
discretisation. If these different finite element function spaces are
chosen so that discrete versions of vector calculus identities hold
then the discretisation is called `mimetic' or `compatible'.



In this article we will describe the current capabilities of Gusto and
the design features that enable our flexible implementation whereby
different spatial and temporal discretisations can be applied to a
range of different equation sets relevant for weather and climate
modelling. In section \ref{sec: governing} we will outline three
different equations commonly used for modelling geophysical fluids in
order to demonstrate the similaries between the equations and justify
the use of a unified codebase. The advantages of this unified approach
become even clearer in section \ref{sec: FEM} where we present the
compatible finite element discretisation of the different types of
terms (e.g. pressure gradient, transport) seen in section \ref{sec:
  governing}. In section \ref{sec: design} we describe the code
structure of Gusto followed by a detailed example (section \ref{sec:
  FML}) of the Form Manipulation Language (FML) that facilitates
symbolic manipulation of the finite element forms within our
timestepping code. Section \ref{sec: results} contains a selection of
numerical results that showcases the range of discretisations
available within Gusto. **mention here new functionality facilitated
by the flexibility of Gusto? We summarise our current status and
future directions in section \ref{sec: summary}.

\section{Governing Equations}
\label{sec: governing}
The aim of this section is to introduce three governing equation sets
commonly used in the development of discretisation methods for weather
and climate models, along with enough detail about the finite element
discretiations provided by Gusto to demonstrate the similarities
between them. These similarities guide the design of the code
structure described in the next section and motivate the use of Form
Manipulation Language (FML) that underlies the flexibility of Gusto, a
detailed example of which will be given in section \ref{sec: FML}. The
convention in Gusto is to write the equations in residual form,
meaning that all the terms appear on the left side. We will follow
this convention below in contrast to many papers which present the
equations with the pressure gradient term and any forcing terms on the
right side.

\subsection{Shallow Water Equations}
The shallow water equations are commonly used for testing numerical
algorithms and for exploring geophysical fluid dynamics concepts under
simplified conditions. They are useful in both contexts since they are
the simplest set of equations that model motion on both the slow,
geostrophic timescale and the much faster timescale of the
inertia-gravity waves. This timescale separation poses challenges to
the numerical discretisation and also provides a rich enough range of
dynamics to explain many of the phenomena observed in the atmosphere
and oceans \citep{zeitlin2018geophysical}.

The shallow water equations describe the flow of a shallow layer of
fluid subject to gravitational and, optionally, rotational forces. The
prognostic variables are the two horizontal velocity components
$\MM{u} = (u, v)$ and the fluid depth $D = H + h - b$ where $H$ is the
undisturbed depth of the fluid layer, $h$ is the free surface
deviation from $H$, and $b$ is the bottom topography, if present. The
equations are:

\begin{align}
  \pp{\MM{u}}{t} + (\MM{u}\cdot\nabla)\MM{u} + f\hat{\MM{k}}\times\MM{u} + g\nabla (D+b) &= 0, \\
  \pp{D}{t} + \nabla\cdot(D\MM{u}) &= 0,
\end{align}
where $f$ is the Coriolis parameter, $\hat{\MM{k}}$ is the unit vector
pointing upwards and $g$ is the acceleration due to gravity.

\subsection{Compressible Boussinesq Equations}
The compressible Boussinesq equations are commonly used in ocean
modelling. They are useful from a numerical discretisation perspective
because they incorporate compressibility effects without the
complexity of discretising the nonlinear pressure gradient terms that
we shall see in the compressible Euler equations. We write these
equations in terms of the prognostic variables $\MM{u}$, $b$ and $p$
where $\MM{u}$ is the velocity field, $b$ is the fluid buoyancy and
$p$ is pressure. In terms of these variables, the equations are:

\begin{align}
  \pp{\MM{u}}{t} + 
  (\MM{u}\cdot\nabla)\MM{u} +
  2\MM{\Omega}\times \MM{u} + \nabla p + b\hat{\MM{k}} & = 0, \\
  \pp{p}{t} + c^2\nabla\cdot\MM{u} & = 0, \\
  \pp{b}{t} + (\MM{u}\cdot\nabla) b & = 0,
\end{align}
where $\MM{\Omega}$ is the rotation vector of the domain,
$\hat{\MM{k}}$ is the unit vector pointing upwards and $c$ is the
acoustic wave speed. The equations have been written in
three-dimensional form but they can also be solved in a
two-dimensional vertical slice domain described by $(x, z)$
coordinates. In this case the velocity $\MM{u}$ can either be
two-dimensional as well (if there is no Coriolis force), or fully
three-dimensional but with each cartensian component only varying in
the $x-z$ plane. In the latter case this is implemented using a
three-dimensional computational domain that is only one element wide
in the $y$-direction and with periodic boundary conditions also in
that direction.

\subsection{Compressible Euler Equations}
The dynamical core at the heart of any weather or climate model solves
the rotating compressible Euler equations that model atmospheric
flow. We write these equations in terms of the prognostic variables
$\MM{u}$, $\rho$ and $\theta$ where $\MM{u}$ is the velocity field,
$\rho$ is the fluid density and $\theta$ is the potential
temperature. The pressure gradient term is written in terms of the
Exner pressure $\Pi$ which is calculated through an equation of
state. In terms of these variables, the equations are:

\begin{align}
  \pp{\MM{u}}{t} + 
  (\MM{u}\cdot\nabla)\MM{u} +
  2\MM{\Omega}\times \MM{u} + c_p\theta\nabla \Pi + g\hat{\MM{k}} & = 0, \\
  \pp{\rho}{t} + \nabla\cdot(\MM{u}\rho) & = 0, \\
  \pp{\theta}{t} + (\MM{u}\cdot\nabla)\theta & = 0, \\
  \Pi^{(1-\kappa)/\kappa} & = \frac{R}{p_0}\rho\theta, & 
\end{align}
where $\Pi$ is the Exner pressure, $p_0$ is a reference pressure, $R$
is the gas constant, $c_p$ is the specific heat at constant pressure
and $\kappa=R/c_p$. The equations have been written in
three-dimensional form but they can also be solved in a
two-dimensional vertical slice domain described by $(x, z)$
coordinates. In this case the velocity $\MM{u}$ can either be two
dimensional as well (if there is no Coriolis force), or fully three
dimensional but with each cartensian component only varying in the
$x-z$ plane. In the latter case this is implemented using a three
dimensional computational domain that is only one element wide in the
$y$-direction and with periodic boundary conditions also in that
direction. \JScomment{I know this repeats what is said above but I
  like that each section is self-contained - I hope that is ok but
  also happy to change it!}

In all of the equation sets described here, the nonlinear velocity
advection term $(\MM{u}\cdot\nabla)\MM{u}$ can be replaced by the sum
of a vorticity-based term and the gradient of the kinetic energy. This
is known as the vector invariant form and it enables the construction
of schemes that conservation energy and/or enstrophy
\citep{mcrae2014energy, bauer2018energy, wimmer2020energy,
  wimmer2021energy}. However, this form can exhibit numerical
instabilities \citep{bell2017numerical} and it is not yet clear which
form is preferable so in Gusto we offer both forms of the equations.

\section{Finite Element Discretisation}
\label{sec: FEM}

Comparing the equation sets given in the previous sections, we see
several similarities. For example, the prognostic equation for the
velocity always contains a nonlinear transport term, a term due to
rotation and a `pressure' gradient term (in shallow water this is the
gradient of the depth but the term plays the same role in the dynamics
and is derived from the pressure gradient term in the full equations
\citep{zeitlin2018geophysical}). The other prognostic fields satisfy
either an advective or continuity form of the transport
equation. These similarities remain when we formulate the compatible
finite element discretisations, as we shall see below, and importantly
this means that the discretisation of these terms can be written and
implemented in software so that it can be applied to any of the
equation sets.

The finite element discretisation is formed by choosing appropriate
function spaces for the prognostic variables, multiplying by test
functions from these function spaces and integrating over the
domain. In addition to this, we integrate by parts when the
inter-element continuity of the basis functions is not sufficient to
define the result of applying the differential operator directly.

In line with the theory outlined in section \ref{}, we always choose
the velocity $\MM{u} \in \mathbb{V}_u$ with $\mathbb{V}_u \subset
H(\text{div})$. The field whose gradient appears in the `pressure'
gradient term is chosen to be in the space $\mathbb{V}_p$ with
$\mathbb{V}_p \subset L_2$, or, in the case of the more complex
nonlinear pressure gradient term for the compressible Euler equations,
it is a function of a variable in this space. The compressible
Boussinesq and compressible Euler equations have a third prognostic
variable, either buoyancy or potential temperature, which is chosen to
be in the space $\mathbb{V}_\theta$ which has degrees of freedom that
are collocated with those of the vertical velocity, mimicking the
Charney-Phillips staggering as discussed in **. These choices are
governed by the properties required of discretisation of the
linearised equation sets (as discussed in section ** and other
refs). To solve the nonlinear equation sets we need to introduce
stable and accurate discretisations of the transport terms and the
nonlinear pressure gradient term in the compressible Euler equation
set. In addition, some test cases require viscous and diffusive terms
to generate converged solutions \ref{}. In the following subsections
we illustrate a non-exhaustive (**probably!) selection of the options
available in Gusto.

\subsection{Pressure gradient term}
The pressure gradient term is discretised in a similar way for each
equation set, with some additional considerations required for the
nonlinear form of this term in the compressible Euler equations. Since
the pressure (or depth, for shallow water) field is discretised in
$\mathbb{V}_p \subset L_2$, meaning that it is discontinuous between
cells, the gradient is not defined globally and the term must be
integrated by parts. In the linear case, using the notation for the
compressible Boussinesq equations, the weak form is

\begin{equation}
\int_\Omega\MM{w}\cdot\nabla p \diff x = -\int_\Omega\nabla\cdot\MM{w}p\diff x, \quad \forall \MM{w} \in \mathbb{V}_u,
\end{equation}
where $\Omega$ denotes the domain and there are no surface terms from
the integration by parts because these vanish on interior element
boundaries since the normal component of $\MM{w}$ is continuous across
element facets and on exterior boundaries we set no normal flow
boundary conditions. However, the pressure gradient term in the
compressible Euler equations, $c_p\theta\nabla\Pi$, is nonlinear and
this introduces an additional complication. Integration by parts is
still required since $\Pi$ is evaluated as a function of the density
$\rho \in \mathbb{V}_\rho$ and $\theta \in \mathbb{V}_\theta$ so is
discontinuous between elements, but then integrating by parts
transfers the differential operator to $\MM{w}\theta$ which is
discontinuous in the horizontal. Following \ref{} we integrate by parts
in each element $e$, giving

\begin{equation}
  c_p\int_e\MM{w}\cdot\theta\nabla\Pi\diff x = -c_p\int_e\nabla\cdot(\MM{w}\theta)\Pi\diff x + c_p\int_{\partial e}\hat{\theta}\MM{w}\cdot\MM{n}\hat{\Pi}\diff S,
\end{equation}
where $\partial e$ denotes the element facets, $\MM{n}$ is the outward
pointing normal to the facet and $\hat{q}$ denotes the value of a
variable $q$ on the facet, which for discontinuous variables does not
have a unique definition. Summing over the domain gives

\begin{equation}
  c_p\int_\Omega\MM{w}\cdot\theta\nabla\Pi\diff x = -c_p\int_\Omega\nabla\cdot(\MM{w}\theta)\Pi\diff x + c_p\int_{\Gamma_v}\jump{\theta\MM{w}\cdot\MM{n}}\avg{\Pi} \diff S,
\end{equation}
where $\Gamma_v$ denotes the vertical element facets, across which
$\theta$ is discontinuous. Here we have chosen, as in \citet{}, to take
the average value of $\Pi$ across the facets, $\avg{\Pi} =
(\Pi^++\Pi^-)/2$, where the $+$ and $-$ indicate each side of the
facet. The brackets $\jump{q} = q^+-q^-$ denote the jump in $q$
across the facet and the integral over the horizontal facets vanishes
since both $\theta$ and $\MM{w}\cdot\MM{n}$ are continuous across
these facets so the jump is zero.

\subsection{Transport terms}
Since the prognostic variables are discretised using different finite
element function spaces $\mathbb{V}_u$, $\mathbb{V}_p$ and
$\mathbb{V}_\theta$, each with different continuity properties between
the elements, the choice of stable transport discretisation is
different for each prognostic variable. 


\subsection{Viscous and diffusive terms}

For the simulations presented here we do not require viscous or
diffusive terms for stability, but sometimes they are required to
produce converged solutions, ie. so that refining the grid does not
lead to smaller and smaller scale motions. Here we present the symmetric
interior penalty discretisation method used for these terms in Gusto.

\begin{equation}
  \nu\int_\Omega\MM{w}\cdot\nabla^2\MM{u}\diff x = \nu\int_\Omega\nabla\MM{w}:\nabla\MM{u}\diff x
\end{equation}

\section{Software Design}
\label{sec: design}
Gusto is built on top of the Firedrake package, an automated system
for solving partial differential equations using the finite element
method. This gives many advantages, not least that it provides the
finite element machinery required to translate the discretisations
written in the previous section in to the matrix-vector equations that
we need to solve. This is done using the Unified Form Language (UFL),
a domain specific language that enables the definition of the finite
element forms within Python. The other packages that Firedrake depends
on are summarised in \citet{davies2022towards} but we note that we
make particular use of higher order mesh representation on curved
manifolds (**ref), extruded meshes (**ref) and the PETSc library
solver options (**ref).

\begin{figure}
  \centering{\includegraphics[width=0.8\textwidth]{gusto_schematic.png}}
\end{figure}

\JScomment{This paragraph should refer to the schematic and explain
  all aspects} The Gusto model comprises a domain and a prognostic
equation set. The domain holds the mesh and the finite element
function spaces along with any other information about the space-time
domain such as the coordinates and the timestep. The prognostic
equation sets are each defined in a python class, making use of the
common finite element forms for the transport and difffusion terms to
set up the residual (defined in section \ref{}) in weak form. At this
point, no particular discretisation of the transport or diffusion
forms is specified. This happens in the \texttt{SpatialMethod} class
which can be used to apply the methods described in section \ref{} to
the relevant terms. Any physics source terms, such as **, are added by
calling the \texttt{Physics} class that defines them. The
\texttt{TimeStepper} class contains the definition of the timestepping
procedure and the \texttt{run} method that loops over the
timesteps. It also sets up diagnostic fields and calls the IO as
required. The simplest timeloop class will just apply one time
discretisation method to the equation set but it is common in weather
and climate prediction models to split the different types of terms
and apply a time discretisation separately to each type of term. For
example, the transport and forcing terms might be solved for
separately, such as in **, which enables explicit transport schemes to
be applied to each field. ** something about SIQN structure. Terms
related to the physics are solved for in the appropriate part of the
iteration loop, with physics processes that occur on `fast' timescales
evaluated more frequently and `slower' physics processes evaluated
just once at the end of the timestep. The choice of where to evaluate
the physics processes in the iteration is also based on the
computational cost and the best way to do this is still an open
research question (**ref).

\begin{itemize}
\item what about initialisation and diagnostics?
\end{itemize}

\begin{algorithm}
  \caption{Pseudocode for SIQN timestep loop}\label{alg:SIQN}
  \begin{algorithmic}
    \STATE
  \end{algorithmic}
\end{algorithm}

\begin{itemize}
\item generic example(s) - no FML, just pseudocode for basic
  timestepper, SIQN and split physics
\item lead in to next section... facilitated by FML i.e. timesteppers don't care what equations they're given because forms are labelled
\end{itemize}

\section{Form Manipulation Language}
\label{sec: FML}
The discussion of the time discretisation so far has been general i.e.
not specific to any particular equation set. This is also true of the
implementation of the timestepping schemes, resulting in modular code
where the equations are defined separately from the timestepping
scheme enabling flexibility in applying different timestepping schemes
to different equations. This powerful functionality is facilitated
through the form manipulation language (FML) which is used to
associate a label to each term in the residual form defined in the
equation class. The timestepping methods are then able to reason about
which manipulations to apply to which forms by applying filters that
check for the presence of a label and, optionally, its value. Here we
will describe the objects required to define labels and filters before
illustrating this with a simple example(s?).

The finite element discretisation of each term in an equation is
represented in Firedrake by a UFL form object. FML defines a
\texttt{Label} object which is used to tag a UFL form to create a
\texttt{Term}, with the intention that the \texttt{Term} represents a
term in the residual.

FML defines a \texttt{Term} object that comprises the
\texttt{ufl.Form} defining the finite element discretisation of the
term and a dictionary of key-value pairs corresponding to the FML
\texttt{Label} objects that apply to this term. An FML \texttt{Label}
object has a name and an optional value, defaulting to \texttt{True}
to indicate the presence of the label. Labels can also be used to tag
parts of the form. For example, the \texttt{subject} label is used to
tag the \texttt{Function} in the \texttt{ufl.Form} that represents the
prognostic variable, or `subject' of the equation. These operations
are composable, so more than one label can be attached to a term. The
end result of labelling the terms in the residual is a
\texttt{LabelledForm} object that holds a list of terms, pairing
individual \texttt{ufl.Form} objects with FML labels. Labelled forms
can be added together, multiplied by floats and have additional terms
added. More complex manipulations are enabled by the
\texttt{label\_map} method that provides a way of filtering the terms
in the form based on their labels, applying different mappings to
terms that pass or fail the conditions defined in the filter. A common
operation might be to filter for terms that have a certain label, such
as \texttt{transport}, drop terms that do not have this label and
multiply those that do by the timestep. We shall demonstrate this in
the following example.

\subsection{Example}

We demonstrate the use of FML by applying a split timestepping scheme
to the 1D advection diffusion equation
\begin{equation}\label{eq:1dadvdiff}
  q_t + cq_x - \kappa q_{xx} = 0,
\end{equation}
where $q$ is a scalar field, $c$ is the constant transporting velocity
and $\kappa$ is the constant diffusivity. The time discretisation
applies an explicit timestep of forward Euler to the transport term
$cq_x$ and an implicit timestep of backward Euler to the diffusion
term $\kappa q_{xx}$:
\begin{align}
  q^* &= q^n - c \Delta t q_x^n, \label{eq:explicit-advdiff} \\
  q^{n+1} - \kappa \Delta t q_{xx}^{n+1} &= q^*, \label{eq:implicit-advdiff}
\end{align}
where $q^n$ is the value of $q$ at time step $n$, $q^*$ is an
intermediate value for $q$ and $\Delta t$ is the timestep.

We illustrate the use of FML for this example in three steps: 1)
define and label the weak form of the residual, 2) build solvers for
the explicit and implicit systems, 3) run the timestepping loop. Since
the intention of this example is to demonstrate FML rather than the
compatible finite element discretisation, we use the space of piecewise
quadratic continuous Lagrange polynomials, denoted by $P_2$, for the
finite element discretisation as this greatly simplifies the
forms. The finite element discretisation of equation
\ref{eq:1dadvdiff} is then
\begin{equation}\label{eq:weak-advdiff}
  \int_\Omega vq_t \diff x + c \int_\Omega v q_x \diff x + \kappa \int_\Omega v_x q_x \diff x = 0, \quad \forall v \in P_2,
\end{equation}
where $v\in P_2$ is the test function and the diffusion term has been
integrated by parts.

Listing \ref{lst:define-residual} presents the code to define this
spatial discretisation of the residual with the $P_2$ function space
denoted by \texttt{V}. Here we omit the code that sets up the mesh,
function spaces and parameters $c$ and $\kappa$, although this can be
found in the supplementary materials. The first two lines define the
test function \texttt{v} and function \texttt{q}, corresponding to $v$
and $q$ in equation \ref{eq:weak-advdiff}. The next four lines define
the residual, i.e. the left side of equation \ref{eq:weak-advdiff},
using the FML labels \texttt{time\_derivative}, \texttt{transport} and
\texttt{diffusion} to tag the corresponding terms. The final line
labels the function \texttt{q} as the subject of this residual,
i.e. the prognostic field. Note that the labels used for tagging just
take the UFL form as their argument and their value is simply the
default, \texttt{True}, in contrast to the \texttt{subject} label that
has the value \texttt{q}.

\lstinputlisting[caption={This code defines and labels the residual corresponding to equation \ref{eq:weak-advdiff}}, label={lst:define-residual}, language=python, firstline=24, lastline=31]{code/advection_diffusion_splitting_example.py}

To define the solvers for the explicit and implicit steps we need to create UFL forms for the left and right sides, given by the following equations
\begin{align}
  \label{eq:explicit-advdiff}
  \int_\Omega vq^* \diff x &= \int_\Omega vq^n \diff x - \Delta t c \int_\Omega v q_x^n \diff x, &\quad \forall v \in P^2, \\
  \label{eq:implicit-advdiff}
  \int_\Omega vq^{n+1} \diff x  + \Delta t \kappa \int_\Omega v_x q_x^{n+1} \diff x &= \int_\Omega vq^* \diff x, &\quad \forall v \in P^2.
\end{align}
To do this we use the \texttt{label\_map} method to loop over the
terms in the residual making use of the predefined mappings
\texttt{drop} and \texttt{keep} to either remove or retain the term
based on the value of the filter. This code is given in listings
\ref{lst:define-explicit} and \ref{lst:define-implicit}. In listing
\ref{lst:define-explicit} we create the left and right sides of
equation \ref{eq:explicit-advdiff}. The left side should only contain
the time derivative term so the filter checks if each term has the
label \texttt{time\_derivative}, keeping the one that does and
dropping all others. To make this the left side of a
\texttt{LinearVariationalProblem}, we replace the subject with a trial
function using the predefined \texttt{replace\_subject} function, a
lightweight wrapper around the UFL replace method which extracts the
subject of the term and replaces it with the new expression, in this
case simply a trial function \texttt{q\_trial}. The right side of the
explicit solver has two forms, one coming from the discretisation of
the time derivative and the other from the transport term. Both are
evaluated using the values of $q$ at time step $n$. We build this by
first dropping the diffusion term (line 6) and then multiplying the
terms that do not have the \texttt{time\_derivative} label by $-\Delta
t$ (line 8), where the minus sign is required to move the term from
the left side to the right side. The final step is to replace the
subject with the function \texttt{qn} that holds the values of $q$ at
time step $n$. We can then extract the UFL forms from
\texttt{lhs\_explicit} and \texttt{lhs\_implicit} to create a
\texttt{LinearVariationalProblem} and corresponding
\texttt{LinearVariationalSolver} that, when solved, will put the
result into the function \texttt{qstar}.

\JScomment{Is the
  labelling for the rhs the clearest? maybe we should keep the terms
  that we want rather than assuming that dropping diffusion gives the
  right thing?}

\lstinputlisting[caption={This code defines the solver for the explicit step of the timestepping method i.e. equation \ref{eq:explicit-advdiff}. \texttt{qn} and \texttt{qstar} are Firedrake \texttt{Functions} with \texttt{qn} holding the values of $q$ at time step $n$ and \texttt{qstar} holding the values of $q$ after the explicit solve.}, label={lst:define-explicit}, language=python, firstline=40, lastline=55]{code/advection_diffusion_splitting_example.py}

The implicit solver is defined in a similar way (see listing
\ref{lst:define-implicit}). To create the left side of equation
\ref{eq:implicit-advdiff} we begin with the original residual, drop
the transport term (line 1), multiply all remaining terms that are not
the time derivative by $\Delta t$ (line 3) and replace the subject
with a trial function (line 5). The right side only contains the form
coming from the discretisation of the time derivative (line 7),
evaluated using the result of the explicit solve, \texttt{qstar} (line
9).

\lstinputlisting[caption={This code defines the solver for the implicit step of the timestepping method i.e. equation \ref{eq:implicit-advdiff}. \texttt{qstar} and \texttt{qnp1} are Firedrake \texttt{Functions} with \texttt{qstar} holding the values after the explicit solve and \texttt{qnp1} holding the values of $q$ at after the implicit solve.}, label={lst:define-implicit}, language=python, firstline=57, lastline=71]{code/advection_diffusion_splitting_example.py}

The final part of the code is the time loop which calls the solve
method of first the explicit solver and then the implicit solver, see
listing \ref{lst:timeloop}. In practice, the code in listings
\ref{lst:define-explicit}-\ref{lst:define-implicit} would be in a
function that could be applied to any residual labeled with the
appropriate labels.

\lstinputlisting[caption={This code is the timeloop implementing the scheme defined in equations \ref{eq:explicit-advdiff}-\ref{eq:implicit-advdiff} using the solvers defined in listings \ref{lst:define-explicit}-\ref{lst:define-implicit}.}, label={lst:timeloop}, language=python, firstline=73, lastline=79]{code/advection_diffusion_splitting_example.py}

This simple example demonstrates the power of manipulating the terms
in the equation based on the presence or absence of certain
labels. The full strength of FML becomes even more apparant when we
exploit information stored in the label value. We use this in two
important situations in Gusto. The first situation is when we require
a linearisation of the residual, for example when applying a Newton
method to the full nonlinear equations \JScomment{should we clarify
  that we mean a specific linearisation because Firedrake can do
  Newton methods without FML?}, or to test a new algorithm or model
setup on linear equations. The second situation is when we need to
evaluate source terms that come from physics schemes. We can
illustrate both situations with simple extensions to the above
example.

First consider the 1D viscous Burgers' equation
\begin{equation}
  u_t + uu_x + \nu u_{xx} = 0.
\end{equation}


\section{Results}
\label{sec: results}
The aim of this section is to present a selection of results that
demonstrate the tools available in Gusto, such as the choice of grids,
HDiv element families, order of finite element spaces, different
spatial discretisation options, timestepping schemes and physics. The
numerical properties of these configurations (convergence, stability,
accuracy and efficiency) have either been demonstrated elsewhere, or
will be investigated more thoroughly in future publications.

To include:
\begin{itemize}
\item terminator toy (Tim)
\item shallow water on different grids and with different HDiv
  families (Nell) e.g. Williamson 5 cubed sphere PV and Galewsky
  icosahedral sphere PV, high res (ref 6)
\item convergence with different RK schemes / multistage schemes using
  Williamson 2 or 6, L2 and Linf errors for D and u (2 plots, one L2,
  one Linf) (Alex)
\item vertical slice Euler - Straka, different orders, illustrates
  recovery for diffusion (Tom)
\item 3D moist bubble with rain (Tom/Alex)
\item spherical gravity wave, Boussinesq (Jemma)
\item spherical baroclinic wave, Euler - whatever people usually plot
  (horizontal slice pressure contours, temperature shading) (Dan)
\item Held Suarez??
\end{itemize}

\subsection{Terminator `toy' chemistry}
This test combines transport and a `toy' chemistry model to
demonstrate physics-dynamics coupling in Gusto (where here chemistry
is the `physics').

\subsection{Shallow water}
The standard suite of shallow water test cases originally proposed in
\citet{williamson1992standard} provides a common starting point for
testing new discretisations. This test suite is usually augmented by
the unstable barotropic jet described in
\citet{galewsky2004initial}. Here we present convergence results for a
variety of timestepping schemes applied to the steady state
geostrophic balance flow (test case 2 from
\citet{williamson1992standard}) and a demonstration of two different
grids and HDiv element families for shallow water flow over a mountain
(test case 5 from \citet{williamson1992standard}) and the unstable
barotropic jet \citep{galewsky2004initial}.

\subsubsection{Convergence results}

\subsubsection{Grids and HDiv elements}

\subsection{Compressible Boussinesq equations}

\subsection{Compressible Euler equations}

\subsubsection{Dense bubble in a vertical slice}

\subsubsection{3D moist rising bubble}

\subsubsection{Baroclinic wave on the sphere}

\subsubsection{Held Suarez}

\section{Summary}
\label{sec: summary}


\conclusions  %% \conclusions[modified heading if necessary]
TEXT

%% The following commands are for the statements about the availability of data sets and/or software code corresponding to the manuscript.
%% It is strongly recommended to make use of these sections in case data sets and/or software code have been part of your research the article is based on.

\codeavailability{TEXT} %% use this section when having only software code available


\dataavailability{TEXT} %% use this section when having only data sets available


\codedataavailability{TEXT} %% use this section when having data sets and software code available


\sampleavailability{TEXT} %% use this section when having geoscientific samples available


\videosupplement{TEXT} %% use this section when having video supplements available


\appendix
\section{}    %% Appendix A

\subsection{}     %% Appendix A1, A2, etc.


\noappendix       %% use this to mark the end of the appendix section. Otherwise the figures might be numbered incorrectly (e.g. 10 instead of 1).

%% Regarding figures and tables in appendices, the following two options are possible depending on your general handling of figures and tables in the manuscript environment:

%% Option 1: If you sorted all figures and tables into the sections of the text, please also sort the appendix figures and appendix tables into the respective appendix sections.
%% They will be correctly named automatically.

%% Option 2: If you put all figures after the reference list, please insert appendix tables and figures after the normal tables and figures.
%% To rename them correctly to A1, A2, etc., please add the following commands in front of them:

\appendixfigures  %% needs to be added in front of appendix figures

\appendixtables   %% needs to be added in front of appendix tables

%% Please add \clearpage between each table and/or figure. Further guidelines on figures and tables can be found below.



\authorcontribution{TEXT} %% this section is mandatory

\competinginterests{TEXT} %% this section is mandatory even if you declare that no competing interests are present

\disclaimer{TEXT} %% optional section

\begin{acknowledgements}
TEXT
\end{acknowledgements}




%% REFERENCES

%% The reference list is compiled as follows:

%% \begin{thebibliography}{}

%% \bibitem[AUTHOR(YEAR)]{LABEL1}
%% REFERENCE 1

%% \bibitem[AUTHOR(YEAR)]{LABEL2}
%% REFERENCE 2

%% \end{thebibliography}

%% Since the Copernicus LaTeX package includes the BibTeX style file copernicus.bst,
%% authors experienced with BibTeX only have to include the following two lines:
%%
\bibliographystyle{copernicus}
\bibliography{references.bib}
%%
%% URLs and DOIs can be entered in your BibTeX file as:
%%
%% URL = {http://www.xyz.org/~jones/idx_g.htm}
%% DOI = {10.5194/xyz}


%% LITERATURE CITATIONS
%%
%% command                        & example result
%% \citet{jones90}|               & Jones et al. (1990)
%% \citep{jones90}|               & (Jones et al., 1990)
%% \citep{jones90,jones93}|       & (Jones et al., 1990, 1993)
%% \citep[p.~32]{jones90}|        & (Jones et al., 1990, p.~32)
%% \citep[e.g.,][]{jones90}|      & (e.g., Jones et al., 1990)
%% \citep[e.g.,][p.~32]{jones90}| & (e.g., Jones et al., 1990, p.~32)
%% \citeauthor{jones90}|          & Jones et al.
%% \citeyear{jones90}|            & 1990



%% FIGURES

%% When figures and tables are placed at the end of the MS (article in one-column style), please add \clearpage
%% between bibliography and first table and/or figure as well as between each table and/or figure.

% The figure files should be labelled correctly with Arabic numerals (e.g. fig01.jpg, fig02.png).


%% ONE-COLUMN FIGURES

%%f
%\begin{figure}[t]
%\includegraphics[width=8.3cm]{FILE NAME}
%\caption{TEXT}
%\end{figure}
%
%%% TWO-COLUMN FIGURES
%
%%f
%\begin{figure*}[t]
%\includegraphics[width=12cm]{FILE NAME}
%\caption{TEXT}
%\end{figure*}
%
%
%%% TABLES
%%%
%%% The different columns must be seperated with a & command and should
%%% end with \\ to identify the column brake.
%
%%% ONE-COLUMN TABLE
%
%%t
%\begin{table}[t]
%\caption{TEXT}
%\begin{tabular}{column = lcr}
%\tophline
%
%\middlehline
%
%\bottomhline
%\end{tabular}
%\belowtable{} % Table Footnotes
%\end{table}
%
%%% TWO-COLUMN TABLE
%
%%t
%\begin{table*}[t]
%\caption{TEXT}
%\begin{tabular}{column = lcr}
%\tophline
%
%\middlehline
%
%\bottomhline
%\end{tabular}
%\belowtable{} % Table Footnotes
%\end{table*}
%
%%% LANDSCAPE TABLE
%
%%t
%\begin{sidewaystable*}[t]
%\caption{TEXT}
%\begin{tabular}{column = lcr}
%\tophline
%
%\middlehline
%
%\bottomhline
%\end{tabular}
%\belowtable{} % Table Footnotes
%\end{sidewaystable*}
%
%
%%% MATHEMATICAL EXPRESSIONS
%
%%% All papers typeset by Copernicus Publications follow the math typesetting regulations
%%% given by the IUPAC Green Book (IUPAC: Quantities, Units and Symbols in Physical Chemistry,
%%% 2nd Edn., Blackwell Science, available at: http://old.iupac.org/publications/books/gbook/green_book_2ed.pdf, 1993).
%%%
%%% Physical quantities/variables are typeset in italic font (t for time, T for Temperature)
%%% Indices which are not defined are typeset in italic font (x, y, z, a, b, c)
%%% Items/objects which are defined are typeset in roman font (Car A, Car B)
%%% Descriptions/specifications which are defined by itself are typeset in roman font (abs, rel, ref, tot, net, ice)
%%% Abbreviations from 2 letters are typeset in roman font (RH, LAI)
%%% Vectors are identified in bold italic font using \vec{x}
%%% Matrices are identified in bold roman font
%%% Multiplication signs are typeset using the LaTeX commands \times (for vector products, grids, and exponential notations) or \cdot
%%% The character * should not be applied as mutliplication sign
%
%
%%% EQUATIONS
%
%%% Single-row equation
%
%\begin{equation}
%
%\end{equation}
%
%%% Multiline equation
%
%\begin{align}
%& 3 + 5 = 8\\
%& 3 + 5 = 8\\
%& 3 + 5 = 8
%\end{align}
%
%
%%% MATRICES
%
%\begin{matrix}
%x & y & z\\
%x & y & z\\
%x & y & z\\
%\end{matrix}
%
%
%%% ALGORITHM
%
%\begin{algorithm}
%\caption{...}
%\label{a1}
%\begin{algorithmic}
%...
%\end{algorithmic}
%\end{algorithm}
%
%
%%% CHEMICAL FORMULAS AND REACTIONS
%
%%% For formulas embedded in the text, please use \chem{}
%
%%% The reaction environment creates labels including the letter R, i.e. (R1), (R2), etc.
%
%\begin{reaction}
%%% \rightarrow should be used for normal (one-way) chemical reactions
%%% \rightleftharpoons should be used for equilibria
%%% \leftrightarrow should be used for resonance structures
%\end{reaction}
%
%
%%% PHYSICAL UNITS
%%%
%%% Please use \unit{} and apply the exponential notation


\end{document}
